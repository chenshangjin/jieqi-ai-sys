# 揭棋AI系统 (Jieqi-AI-Sys) 综合分析文档

## 维护信息

此文档主要由Lingma AI助手维护。

## 项目概述

jieqi-ai-sys 是一个中国象棋（揭棋）AI解决方案，支持在Android手机天天象棋应用中使用AI辅助。该系统专为"揭棋"玩法设计，即棋子初始状态下是暗子，只有移动后才会显示真实身份。

### 核心特性
- **高性能搜索算法**: 使用Alpha-Beta剪枝和PVS（Principal Variation Search）
- **多语言实现**: Python版本用于开发，C++版本用于高性能部署
- **揭棋特化**: 支持处理暗子/明子状态切换
- **开局库支持**: 集成中象开局库优化搜索
- **可视化界面**: Pygame-based Windows GUI

## 系统架构

### 1. AI引擎模块 (src/ai/engine.py)
AI引擎是系统的核心，实现了以下关键功能：

#### 核心算法
- **搜索算法**: PVS（主变例搜索）、Alpha-Beta剪枝
- **评估函数**: 结合子力价值和位置评估，特别考虑暗子的不确定性
- **优化技术**: 置换表、空着启发、静止搜索等

#### 关键类和方法
- `Position`类: 表示棋局状态
  - `set()`: 初始化
  - `gen_moves()`: 生成合法着法
  - `move(move)`: 执行着法
  - `rotate()`: 局面旋转(用于搜索)
  - `nullmove()`: 空着
  - `value(move)`: 计算着法价值
  - `mymove_check()`: 验证己方着法

- `Searcher`类: 搜索器
  - `alphabeta(pos, alpha, beta, depth, root)`: Alpha-Beta搜索
  - `search(pos, history)`: 主搜索接口
  - `calc_average()`: 计算平均值

### 2. 棋盘模块 (src/board/)
棋盘模块包含完整的规则验证和棋盘管理功能：

#### 棋盘表示
- 使用256字符表示棋盘，每个位置用二进制编码表示棋子类型、颜色和明暗状态
- 位编码:
  - 位0-2: 棋子类型 (0=无 1=车 2=马 3=相 4=士 5=帅 6=炮 7=兵)
  - 位3: 明/暗标记 (0=明 1=暗)
  - 位4: 红/黑标记 (1=红 0=黑)

#### 核心功能
- `check_legal()`: 验证着法合法性
- `get_legal_moves_speedup()`: 快速生成合法着法
- `evaluate()`: 揭棋局面评分函数
- `uncover_board()`: 暗子翻开功能

### 3. GUI界面模块 (src/gui/main.py)
- **图形界面**: 使用Pygame实现的棋盘界面
- **AI交互**: 通过子进程与AI引擎通信
- **操作支持**: 鼠标点击选择棋子和走法

### 4. 开局库模块 (src/board/library.py)
包含预定义的开局走法和局面评估。

## 技术特点

### 揭棋特化设计
1. **暗子/明子机制**: 处理初始暗子状态和翻开后的明子状态
2. **不确定性评估**: 计算暗子可能类型的价值期望
3. **动态映射**: 维护暗子到明子的映射关系

### 高效搜索算法
1. **PVS搜索**: 主变例搜索算法，提高搜索效率
2. **Alpha-Beta剪枝**: 经典博弈树搜索优化
3. **置换表**: 缓存已搜索的局面，避免重复计算
4. **空着启发**: 快速剪枝低分值节点

### 评估函数
1. **位置评估表(PST)**: 评估棋子位置优劣
2. **子力价值评估**: 结合子力价值评估当前局面
3. **折扣因子**: 动态调整应对搜索深度

## Android客户端接口设计

### 通信架构
```
Android Client -> HTTP Server -> AI Engine (Python/C++)
```

### API端点设计

#### 1. 获取AI推荐着法
- **端点**: `POST /api/v1/chess/move`
- **请求体**:
```json
{
  "board_state": "256-character string representing the board",
  "current_player": "RED" | "BLACK",
  "mapping": {
    "position_index": "piece_type"
  },
  "captured_pieces": {
    "red": ["piece1", "piece2"],
    "black": ["piece1"]
  },
  "game_history": [...]
}
```

#### 2. 棋盘状态分析
- **端点**: `POST /api/v1/chess/analyze`

#### 3. 棋子识别接口
- **端点**: `POST /api/v1/chess/recognize`

### 数据传输格式

#### 棋盘状态表示
- 采用256字符字符串表示法
- 字符含义：
  - `R,N,B,A,K,C,P` - 红方明子
  - `r,n,b,a,k,c,p` - 黑方明子  
  - `D,E,F,G,H,I` - 红方暗子
  - `d,e,f,g,h,i` - 黑方暗子
  - `.` - 空位

#### 位置编码
- 采用UCCI协议的位置编码（a-i, 0-9）
- 例如：`h2e2` 表示从h2位置移动到e2位置

## C++高性能版本

### 编译配置
- 需要CMake 3.15+和C++17编译器
- 包含AIBoard3/4/5不同强度的AI版本

### 配置文件
- `players.conf`: 玩家配置文件
- `score.conf`: 评估参数配置

## 项目完成度分析

### 已完成的部分
1. **完整的AI引擎架构**
2. **棋盘逻辑和规则验证**
3. **GUI界面**
4. **揭棋特有的暗子/明子处理机制**
5. **搜索算法和评估函数**

### 待完善的部分
1. **Android客户端**（规划中）
2. **图像识别功能**（用于识别天天象棋界面）
3. **更强大的AI算法**
4. **GUI界面的一些已知问题**（如棋子颜色显示）

## 工作流程
1. 玩家在天天象棋应用中截图或实时采集棋局画面
2. 将棋局数据上传至服务器
3. 服务器使用AI算法分析当前局面
4. 服务器返回最佳着法建议
5. 玩家根据建议执行走棋

## 技术栈
- **Python**: AI引擎、棋盘逻辑、GUI界面
- **C++**: 高性能版本
- **Pygame**: GUI界面
- **UCCI协议**: 棋类通用接口协议

## 扩展计划
1. **短期**: 完善GUI功能和性能，实现图像识别模块，建立HTTP服务器
2. **中期**: Android客户端开发，云部署支持，开局库扩展
3. **长期**: 机器学习评估函数，多线程搜索优化，棋力等级排名系统

此系统展现了高质量的AI算法实现，特别针对中国象棋中的揭棋玩法进行了优化，具有很高的技术水平和实用价值。